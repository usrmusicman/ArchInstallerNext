#!/bin/sh

# Archlinux with Plasma KDE base
BASE_SYSTEM="discover distrobox ffmpeg4.4 ffmpegthumbs flatpak gamemode gamescope gst-libav gst-plugin-libcamera gst-plugin-pipewire gst-plugins-bad gst-plugins-base gst-plugins-good gst-plugins-ugly gst-plugin-va haruna icoutils ifuse kio-admin kio-gdrive kio-zeroconf ksshaskpass lib32-gamemode lib32-gst-plugins-base lib32-gst-plugins-base-libs lib32-gst-plugins-good lib32-mangohud lib32-mesa-demos lib32-mesa-utils lib32-pipewire-v4l2 libappimage libdvdcss libgpod libimobiledevice libva-utils man-db man-pages mangohud mesa-demos mesa-utils mtools multilib-devel net-tools noto-fonts noto-fonts-cjk noto-fonts-emoji nss-mdns ntfs-3g onlyoffice-bin openrgb-git openssh partitionmanager pipewire-alsa pipewire-audio pipewire-ffado pipewire-libcamera pipewire-pulse pipewire-session-manager pipewire-v4l2 pkgstats podman podman-compose proton-cachyos-slr pulsemixer qpwgraph realtime-privileges sane sane-airscan soundfont-fluid spectacle steam system-config-printer thunderbird ufw unarchiver unrar umu-launcher vim vim-runtime vulkan-tools wacomtablet wget wireless-regdb wireplumber xdg-user-dirs-gtk yt-dlp"

# <<-- Functions -->>

# Make sure to run the script as root
if [[ "$USER" == "root" ]]; then

	# Enable ntsync for wine
	install -Dm644 etc/modules/10-ntsync.conf $MOUNT_DIR/etc/modules-load.d/10-ntsync.conf

	# Enable network roaming discovery with avahi
	install -Dm644 etc/nsswitch.conf $MOUNT_DIR/etc/nsswitch.conf

	# Install SDDM configs
	install -Dm644 etc/sddm/virtualkbd.conf $MOUNT_DIR/etc/sddm.conf.d/virtualkbd.conf

	# Install flathub as a user
	install -Dm755 etc/skel/Desktop/enable_flathub_as_user $MOUNT_DIR/etc/skel/Desktop/enable_flathub_as_user

	# Install snapper installer script
	install -Dm755 etc/skel/Desktop/enable_snapshots $MOUNT_DIR/etc/skel/Desktop/enable_snapshots

	# Install nvidia driver toggle script
	install -Dm755 etc/skel/Desktop/nvidia_driver_toggle $MOUNT_DIR/etc/skel/Desktop/nvidia_driver_toggle

	# Install pipewire-jack package before the base-system
	pacman -Syy lib32-pipewire-jack pipewire-jack

	# Install system packages
	pacman -Syy --noconfirm $BASE_SYSTEM

	# Run final system package update
	pacman -Suu --noconfirm

	# Enable system services
    systemctl enable avahi-daemon.service
    systemctl enable avahi-dnsconfd.service
    systemctl enable bluetooth.service
    systemctl enable cups.service
    systemctl enable dbus-broker.service
    systemctl enable power-profiles-daemon.service
    systemctl enable scx_loader.service
    systemctl enable sddm.service
    systemctl enable ufw.service
    systemctl enable NetworkManager.service

	# Make vim the default system-wide editor
	echo "EDITOR=/usr/bin/vim" > $MOUNT_DIR/etc/environment

	# Make the fluid soundfont the default for midi playback
	echo "SOUND_FONT=/usr/share/soundfonts/FluidR3_GM.sf2" > $MOUNT_DIR/etc/conf.d/fluidsynth

	# Add user to groups
	gpasswd -a $USER cups
	gpasswd -a $USER flatpak
	gpasswd -a $USER fwupd
	gpasswd -a $USER gamemode
	gpasswd -a $USER games
	gpasswd -a $USER realtime
	gpasswd -a $USER sddm

else

	# Check if the user is root
    echo "Please be root to run this script..."

fi
