#!/bin/sh

# Archlinux with Plasma KDE base
BASE_SYSTEM="7zip alsa-utils apparmor argyllcms ark bash-completion bluez bluez-cups bluez-hid2hci bluez-obex breeze5 btrfs-progs cups cups-browsed cups-pdf cups-pk-helper dbus-broker distrobox dosfstools exfatprogs ffmpeg4.4 ffmpegthumbs firefox gamemode gamescope gst-libav gst-plugin-libcamera gst-plugin-pipewire gst-plugins-bad gst-plugins-base gst-plugins-good gst-plugins-ugly gst-plugin-va gwenview haruna icoutils ifuse kamera kate kcalc kdialog kio-admin kio-gdrive kio-zeroconf konsole kompare lib32-gamemode lib32-gst-plugins-base lib32-gst-plugins-base-libs lib32-gst-plugins-good lib32-mangohud lib32-mesa-demos lib32-mesa-utils lib32-pipewire-jack lib32-pipewire-v4l2 libappimage libdvdcss libgpod libimobiledevice libva-utils lshw man-db man-pages mangohud mesa-demos mesa-utils mkinitcpio-firmware mtools multilib-devel net-tools noto-fonts noto-fonts-cjk noto-fonts-emoji nss-mdns ntfs-3g onlyoffice-bin openrgb-git  openssh os-prober orca partitionmanager phonon-qt6-vlc pipewire-alsa pipewire-audio pipewire-ffado pipewire-jack pipewire-libcamera pipewire-pulse pipewire-session-manager pipewire-v4l2 pkgstats plymouth plymouth-kcm podman podman-compose power-profiles-daemon pulse-native-provider pulsemixer qt6-multimedia qt6-multimedia-ffmpeg qpwgraph realtime-privileges sane sane-airscan soundfont-fluid spectacle steam system-config-printer thunderbird ttf-ms-fonts ufw unarchiver unrar umu-launcher usbguard usbmuxd vim vim-runtime vulkan-tools wacomtablet wget wireless-regdb wireplumber xdg-user-dirs-gtk yt-dlp zram-generator"

# <<-- Functions -->>

# Make sure to run the script as root
if [[ "$USER" == "root" ]]; then

	main_installation() {

		# Enable ntsync for wine
		install -Dm644 etc/modules/10-ntsync.conf $MOUNT_DIR/etc/modules-load.d/10-ntsync.conf

		# Enable network roaming discovery with avahi
		install -Dm644 etc/nsswitch.conf $MOUNT_DIR/etc/nsswitch.conf

		# Install SDDM configs
		install -Dm644 etc/sddm/virtualkbd.conf $MOUNT_DIR/etc/sddm.conf.d/virtualkbd.conf

		# ZRAM Generator Config
		install -Dm644 etc/systemd/zram-generator.conf $MOUNT_DIR/etc/systemd/zram-generator.conf

		# Install flathub as a user
		install -Dm755 etc/skel/Desktop/enable_flathub_as_user $MOUNT_DIR/etc/skel/Desktop/enable_flathub_as_user

		# Install snapper installer script
		install -Dm755 etc/skel/Desktop/enable_snapshots $MOUNT_DIR/etc/skel/Desktop/enable_snapshots

		# Install nvidia driver toggle script
		install -Dm755 etc/skel/Desktop/nvidia_driver_toggle $MOUNT_DIR/etc/skel/Desktop/nvidia_driver_toggle

		# Install system packages
		arch-chroot ${MOUNT_DIR} pacman -Syy --noconfirm $BASE_SYSTEM

		# Run final system package update
		arch-chroot ${MOUNT_DIR} pacman -Suu --noconfirm

		# Enable system services
		arch-chroot ${MOUNT_DIR} systemctl enable apparmor.service
		arch-chroot ${MOUNT_DIR} systemctl enable avahi-daemon.service
		arch-chroot ${MOUNT_DIR} systemctl enable avahi-dnsconfd.service
		arch-chroot ${MOUNT_DIR} systemctl enable bluetooth.service
		arch-chroot ${MOUNT_DIR} systemctl enable cups.service
		arch-chroot ${MOUNT_DIR} systemctl enable cups-browsed.service
		arch-chroot ${MOUNT_DIR} systemctl enable dbus-broker.service
		arch-chroot ${MOUNT_DIR} systemctl enable power-profiles-daemon.service
		arch-chroot ${MOUNT_DIR} systemctl enable scx.service
		arch-chroot ${MOUNT_DIR} systemctl enable scx_loader.service
		arch-chroot ${MOUNT_DIR} systemctl enable sddm.service
		arch-chroot ${MOUNT_DIR} systemctl enable ufw.service
		arch-chroot ${MOUNT_DIR} systemctl enable NetworkManager.service

		# Make vim the default system-wide editor
		echo "EDITOR=/usr/bin/vim" > $MOUNT_DIR/etc/environment

		# Make the fluid soundfont the default for midi playback
		echo "SOUND_FONT=/usr/share/soundfonts/FluidR3_GM.sf2" > $MOUNT_DIR/etc/conf.d/fluidsynth

		# Add user to groups
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME audio
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME cups
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME flatpak
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME fwupd
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME gamemode
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME games
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME realtime
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME sddm
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME video
		arch-chroot ${MOUNT_DIR} gpasswd -a $USERNAME wheel

	}

# <<-- Program Logic -->>

	if [[ "$CONFIRM" == "yes" ]]; then

		# Main system installation
		echo "Installing system..."
		echo ""
		main_installation
		sleep 5
		clear

	else

		# exit script
		exit

	fi

else

	# Check if the user is root
    echo "Please be root to run this script..."

fi
